---
title: "Nombre de postes depuis 2002 pour les sections CNU"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggcpesrthemes)

theme_cpesr_setup(authors=c("Florent Figon, Julien Gossa"), licence="LO 2.0", source = "DGRH A1-1")

cnu.sections <- read.csv2("../data/cpesr-cnu-sections.csv")
emploisEC <- read.csv2("../data/cpesr-emplois-ec.csv", stringsAsFactors = TRUE) 

# source("../R/emploiEC-metriques.R")
# source("../R/emploiEC-plot-series.R")
# source("../R/emploiEC-plot-metrique.R")
# source("../R/emploiEC-plot-flux.R")
# source("../R/emploiEC-plot-sections.R")
# source("../R/emploiEC-plot-groupes.R")
# source("../R/emploiEC-plot-contexte.R")
```

```
- twtexte:[#DataESR] Evolution du nombre de postes d'enseignant-chercheur
- twalt:@ffigon @juliengossa LO 2.0 www.cpesr.fr
- twurl:https://twitter.com/CPESR_/status/1498228236710559744
- url:https://cpesr.fr/lentree-dans-la-carriere-des-enseignants-chercheurs/
```


```{r funs}
plot_postes <- function(métrique, métriquelab = "Postes publiés", périm="Ensemble", périm.id="Ensemble") {
  df <- emploisEC %>%
    filter(Périmètre == périm, Périmètre.ID == périm.id) %>%
    mutate(Données = ifelse(Source == "Galaxie","Temporaires (Galaxie)", "Définitives (CNU)")) %>%
    filter(!is.na(!!as.symbol(métrique)))
  
  df %>%
    ggplot(aes_string(x="Année", y=métrique)) + 
      geom_smooth(se=F,size=0.5) + 
      geom_point(aes(color=Données),size=2) + 
      expand_limits(y=0) +
      scale_color_manual(values=c("blue","orange"), breaks=c("Définitives (CNU)","Temporaires (Galaxie)")) +
      theme_cpesr_cap() + 
      theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm")) +
      #theme(legend.position = "right") +
      scale_x_continuous(breaks = c(seq(min(df$Année),2025,5))) +
      labs(y = métriquelab, x = "Année") 
}

#plot_postes("Concours.Postes.MCF", périm="Section", périm.id="27")
```


## Concours de Maître de Conférences

```{r ensemble.mcf, fig.width=7, fig.asp=9/16}
plot_postes("Concours.Postes.MCF") +
  ggtitle("Postes publiés au concours de Maître de Conférences")
```

## Concours de Professeur des universités

```{r ensemble.pr, fig.width=7, fig.asp=9/16}
plot_postes("Concours.Postes.PR") +
  ggtitle("Postes publiés au concours de Professeur des universités") 
```


```{r gd.postes, fig.width=7, fig.asp=9/16, results='asis'}

périmètres <- emploisEC %>% 
  select(Périmètre,Périmètre.ID,Périmètre.label) %>% 
  unique() %>%
  filter(Périmètre.ID != "Santé") %>%
  na.omit()

# for (s in 2:min(nrow(cnu.sections),1000)) { 
#   gd <- cnu.sections[s,"GrandeDisciplineCNU.ID"]
#   gd.lab <- cnu.sections[s,"GrandeDisciplineCNU"]
#   groupe <- cnu.sections[s,"GroupeCNU.ID"]
#   groupe.lab <- cnu.sections[s,"GroupeCNU"]
#   section <- cnu.sections[s,"SectionCNU.ID"]
#   section.lab <- cnu.sections[s,"SectionCNU"]

for(gd in gds) {

  cat(paste0("\n\n## MCF en ", gd,"\n"))
  print(
    postes %>% filter(GrandeDisciplineCNU == gd, Corps == "MCF") %>% 
    group_by(Année, Donnée) %>% summarise(Postes = sum(Postes,na.rm = TRUE)) %>%
    plot_section(paste0("Concours MCF ", gd))
    )
  
  cat(paste0("\n\n## PR en ", gd,"\n"))
  print(
    postes %>% filter(GrandeDisciplineCNU == gd, Corps == "PR") %>% 
    group_by(Année, Donnée) %>% summarise(Postes = sum(Postes,na.rm = TRUE)) %>%
    plot_section(paste0("Concours PR ", gd))
    )
  
}
```

```{r evolution.postes, fig.width=7, fig.asp=9/16, results='asis'}
sec <- postes %>% select(SectionCNU, SectionCNU.ID) %>% unique()
for(s in 1:nrow(sec)) {
  section <- sec[s,1]
  sectionid <- sec[s,2]

  if (sectionid == 75 | sectionid >= 90) next
  
  cat(paste0("\n\n## MCF Section CNU ", sectionid," ", section,"\n"))
  print(
    postes %>% filter(SectionCNU.ID==as.numeric(sectionid), Corps == "MCF") %>% 
    plot_section(paste0("Concours MCF section CNU ", sectionid), str_wrap(section,80))
    )
  
  cat(paste0("\n\n## PR Section CNU ", sectionid," ", section,"\n"))
  print(
    postes %>% filter(SectionCNU.ID==as.numeric(sectionid), Corps == "PR") %>% 
    plot_section(paste0("Concours PR section CNU ", sectionid), str_wrap(section,80))
    )
  
}
```