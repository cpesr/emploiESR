---
title: "Nombre de postes depuis 2002 pour les sections CNU"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
library(tidyverse)
library(ggcpesrthemes)

theme_cpesr_setup(authors=c("Florent Figon, Julien Gossa"), licence="LO 2.0", source = "DGRH A1-1")


## Galaxie

galaxie <- bind_rows(
  # read.csv("../utils/galaxie-excavator/galaxie.2018.csv") %>% mutate(Année = 2018),
  # read.csv("../utils/galaxie-excavator/galaxie.2019.csv") %>% mutate(Année = 2019),
  # read.csv("../utils/galaxie-excavator/galaxie.2020.csv") %>% mutate(Année = 2020),
  read.csv("../utils/galaxie-excavator/galaxie.2021.csv") %>% mutate(Année = 2021),
  read.csv("../utils/galaxie-excavator/galaxie.2022.csv") %>% mutate(Année = 2022)
) %>%
  group_by(Année,Corps,SectionCNU.ID = Section) %>%
  summarise(Concours.postes = n()) %>%
  pivot_wider(values_from = Concours.postes, names_from = Corps, names_prefix = "Concours.Postes.") 



postes <- bind_rows(
  read.csv2("../data/cpesr-emplois-cnu-mcf-2002-2008.csv") %>% mutate(Donnée = "Définitive (CNU)"),
  read.csv2("../data/cpesr-emplois-cnu-qualification-concours.csv") %>% 
    filter(Périmètre == "Section") %>%
    mutate(SectionCNU.ID = as.numeric(as.character(Périmètre.ID))) %>%
    mutate(Donnée = "Définitive (CNU)"),
  galaxie %>% mutate(Donnée = "Temporaire (Galaxie)")
  ) %>% 
  select(Année,SectionCNU.ID,Donnée,Concours.Postes.MCF,Concours.Postes.PR) %>%
  left_join(read.csv2("../data/cpesr-cnu-sections.csv")) %>%
  pivot_longer(starts_with("Concours.Postes."), names_to = "Corps", values_to = "Postes", names_prefix = "Concours.Postes.") %>%
  filter(!is.na(Postes))
```

```
- twtexte:[#DataESR] Evolution du nombre de postes d'enseignant-chercheur
- twalt:@ffigon @juliengossa LO 2.0 www.cpesr.fr
- twurl:https://twitter.com/CPESR_/status/1498228236710559744
- ulr:https://cpesr.fr/lentree-dans-la-carriere-des-enseignants-chercheurs/
```


```{r funs}
plot_section <- function(data, title, subtitle=NULL) {
    ggplot(data, aes(x=Année, y=Postes)) + 
      geom_smooth(se=F,size=0.5) + 
      geom_point(aes(color=Donnée),size=2) + 
      expand_limits(y=0) +
      scale_color_manual(values=c("blue","orange"), breaks=c("Définitive (CNU)","Temporaire (Galaxie)")) +
      theme_cpesr_cap() + 
      theme(plot.margin = margin(0.5, 0.5, 0.5, 0.5, "cm")) +
      #theme(legend.position = "right") +
      scale_x_continuous(breaks = seq(2000,2025,5)) +
      labs(title=title, subtitle=subtitle, y ="Postes publiés", x = "Année") 
}
```


## Concours de Maître de Conférences

```{r ensemble.mcf, fig.width=7, fig.asp=9/16}
postes %>%
  filter(Corps == "MCF") %>%
  group_by(Année,Donnée,Corps) %>%
  summarise(Postes = sum(Postes, na.rm = TRUE)) %>%
  plot_section("Postes publiés au concours de Maître de Conférences")
```

## Concours de Professeur des universités

```{r ensemble.pr, fig.width=7, fig.asp=9/16}
postes %>%
  filter(Corps == "PR") %>%
  group_by(Année,Donnée,Corps) %>%
  summarise(Postes = sum(Postes, na.rm = TRUE)) %>%
  plot_section("Postes publiés au concours de Professeur des universités") 
```


```{r gd.postes, fig.width=7, fig.asp=9/16, results='asis'}
gds <- c("Droit éco gestion", "Lettres et sciences humaines", "Sciences et techniques", 
"Pharmacie")
for(gd in gds) {

  cat(paste0("\n\n## MCF en ", gd,"\n"))
  print(
    postes %>% filter(GrandeDisciplineCNU == gd, Corps == "MCF") %>% 
    group_by(Année, Donnée) %>% summarise(Postes = sum(Postes,na.rm = TRUE)) %>%
    plot_section(paste0("Concours MCF ", gd))
    )
  
  cat(paste0("\n\n## PR en ", gd,"\n"))
  print(
    postes %>% filter(GrandeDisciplineCNU == gd, Corps == "PR") %>% 
    group_by(Année, Donnée) %>% summarise(Postes = sum(Postes,na.rm = TRUE)) %>%
    plot_section(paste0("Concours PR ", gd))
    )
  
}
```

```{r evolution.postes, fig.width=7, fig.asp=9/16, results='asis'}
sec <- postes %>% select(SectionCNU, SectionCNU.ID) %>% unique()
for(s in 1:nrow(sec)) {
  section <- sec[s,1]
  sectionid <- sec[s,2]

  if (sectionid == 75 | sectionid >= 90) next
  
  cat(paste0("\n\n## MCF Section CNU ", sectionid," ", section,"\n"))
  print(
    postes %>% filter(SectionCNU.ID==as.numeric(sectionid), Corps == "MCF") %>% 
    plot_section(paste0("Concours MCF section CNU ", sectionid), str_wrap(section,80))
    )
  
  cat(paste0("\n\n## PR Section CNU ", sectionid," ", section,"\n"))
  print(
    postes %>% filter(SectionCNU.ID==as.numeric(sectionid), Corps == "PR") %>% 
    plot_section(paste0("Concours PR section CNU ", sectionid), str_wrap(section,80))
    )
  
}
```